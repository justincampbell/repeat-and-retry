#!/usr/bin/env sh

set -e

OPTIND=1

desired_status=0
sleep_duration=1

show_help() {
  echo "rr"
  echo "github.com/justincampbell/rr"
  echo ""
  echo "  Usage:"
  echo "    repeat  Repeat a command until it fails"
  echo "    retry   Retry a command until it succeeds"
}

while getopts "01hn:" opt; do
  case "$opt" in
    0)
      desired_status=0
      ;;
    1)
      desired_status=1
      ;;
    h)
      show_help
      exit 0
      ;;
    n)
      sleep_duration=$OPTARG
      ;;
  esac
done

shift $((OPTIND-1))

if [ -z "$@" ]; then
  show_help
  exit 1
fi

while true; do
  date

  set +e
  $@; status=$?
  set -e

  if [ $status = 0 ]; then
    if [ $desired_status = 0 ]; then exit 0; fi
  else
    if [ $desired_status = 1 ]; then exit $status; fi
  fi

  sleep $sleep_duration
done
